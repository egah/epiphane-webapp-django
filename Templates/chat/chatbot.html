<html>
  <!--This is my chatbot interface page. can correct the chatbot.html and chatbot.css to make the styling to make the tag correspond with the script tag to make the script functions works. To do so you need static/css/chatboot.css-->
  <head>

  <head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
  </head>

  <body>
    <button class="chatbot-toggler">
      <span class="material-symbols-rounded">mode_comment</span>
    </button>
    <div class="chatbot">
      <header>
        <h1>epiphane-ai</h1>
      </header>
      <ul class="chatbox" id="chat-log">
        <!-- Chat messages will be appended here -->
      </ul>
      <div class="chat-input">
        <textarea placeholder="Enter a message..." spellcheck="false" required id="chat-message-input"></textarea>
        <button id="send-btn" class="material-symbols-rounded">send</button>
      </div>
    </div>
    <script>
    var wss_protocol = window.location.protocol == "https:" ? "wss://" : "ws://";
    var chatSocket = new WebSocket(
        wss_protocol + window.location.host + "/ws/chat/"
    );
    var messages = [];

    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var message = data["text"];
        messages.push(message);

        var str = '<div class="space-y-2">';
        messages.forEach(function (msg) {
            str += `<p class="flex ${msg.source == "bot" ? "justify-start" : "justify-end"}">
                        <div class="chat-bubble ${msg.source == "bot" ? "left" : "right"}">${msg.msg}</div>
                    </p>`;
        });
        str += "</div>";
        document.querySelector("#chat-log").innerHTML = str;
    };

    chatSocket.onclose = function (e) {
        alert("Socket closed unexpectedly, please reload the page.");
    };

    document.querySelector("#chat-message-input").focus();
    document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) { // enter, return
            document.querySelector("#send-btn").click();
        }
    };

    document.querySelector("#send-btn").onclick = function (e) {
        var messageInputDom = document.querySelector("#chat-message-input");
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({ text: message }));
        messageInputDom.value = "";
    };
</script>
  </body>
 
    var wss_protocol = window.location.protocol == "https:" ? "wss://" : "ws://";
    var chatSocket = new WebSocket(
        wss_protocol + window.location.host + "/ws/chat/"
    );
    var messages = [];

    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var message = data["text"];
        messages.push(message);

        var str = '<div class="space-y-2">';
        messages.forEach(function (msg) {
            str += `<p class="flex ${msg.source == "bot" ? "justify-start" : "justify-end"}">
                        <div class="chat-bubble ${msg.source == "bot" ? "left" : "right"}">${msg.msg}</div>
                    </p>`;
        });
        str += "</div>";
        document.querySelector(".chat-box").innerHTML = str;
    };

    chatSocket.onclose = function (e) {
        alert("Socket closed unexpectedly, please reload the page.");
    };

    document.querySelector("#chat-message-input").focus();
    document.querySelector("#chat-message-input").onkeyup = function (e) {
        if (e.keyCode === 13) {
            // enter, return
            document.querySelector("#chat-message-submit").click();
        }
    };

    document.querySelector("#chat-message-submit").onclick = function (e) {
        var messageInputDom = document.querySelector("#chat-message-input");
        var message = messageInputDom.value;
        chatSocket.send(
            JSON.stringify({
                text: message,
            })
        );

        messageInputDom.value = "";
    };
</script>
</html>