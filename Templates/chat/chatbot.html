<!DOCTYPE html>
<html>

<head>
    <title>Chat Interface</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    {% load static %}
<link rel="stylesheet" href="{% static 'css/chat-ui.css'%}">
</head>

<body>
    <div class="">
        <p id="title">Chat UI</p>
    </div>
    <div class="container">
        <div id="chat-log" class="chat-box" style="padding-left:auto ;">
        </div>

        <footer>
            Powered by
        </footer>
        
        <!-- code : adapt the input area the be able to write multiline message-->

        <!--add a bot icon in frontof all boot message-->

        <!--add an icon in front of all user message-->

        <!--avoid the div.chat-box to confuse with the div>.input-area when the chat start to be long-->

        <!--add a footer that says powered by in the bootm of the chat -->

        <br></br>
        <br></br>
        <br></br>

        <div class="icon-bar input-area">
            <textarea id="chat-message-input" class="form-control" placeholder="Type and Send" rows="1"></textarea>
            <button id="chat-message-submit" class="">
                <img width="48" height="48" src="https://img.icons8.com/color/48/up--v1.png" alt="Up Arrow" class="icon">
            </button>
        
        </div>
       

    </div>
    


    

    <script>
        var wss_protocol = window.location.protocol == "https:" ? "wss://" : "ws://";
        var chatSocket = new WebSocket(
            wss_protocol + window.location.host + "/ws/chat/"
        );
        var messages = [];

        chatSocket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            var message = data["text"];
            messages.push(message);

            var str = '<div class="space-y-2">';
            messages.forEach(function (msg) {
                str += `<p class="flex ${msg.source == "bot" ? "justify-start bot-message" : "justify-end user-message"}">
                            <img src="${msg.source == "bot" ? "bot-icon-url" : "user-icon-url"}" class="message-icon">
                            <div class="chat-bubble ${msg.source == "bot" ? "bot" : "user"}">${msg.msg}</div>
                        </p>`;
            });
            str += "</div>";
            document.querySelector(".chat-box").innerHTML = str;

            var chatBox = document.querySelector(".chat-box");
                    
            chatBox.scrollTop = chatBox.scrollHeight;

        };

        chatSocket.onclose = function (e) {
            alert("Socket closed unexpectedly, please reload the page.");
        };

        document.querySelector("#chat-message-input").focus();
        document.querySelector("#chat-message-input").onkeyup = function (e) {
            if (e.keyCode === 13) {
                // enter, return
                document.querySelector("#chat-message-submit").click();
            }
        };

        document.querySelector("#chat-message-submit").onclick = function (e) {
            var messageInputDom = document.querySelector("#chat-message-input");
            var message = messageInputDom.value;
            chatSocket.send(
                JSON.stringify({
                    text: message,
                })
            );

            messageInputDom.value = "";
        };
    </script>

</body>

</html>
